---

- set_fact:
    galaxy_docker_env_vars: "{{ galaxy_docker_env_vars | combine(slurm_galaxy_docker_env_vars) }}"

- set_fact:
    galaxy_docker_volumes: "{{ galaxy_docker_volumes + slurm_galaxy_docker_volumes }}"

- name: Generate munge key with password
  shell: echo -n "{{ galaxy_munge_key_password }}" | sha512sum | cut -d' ' -f1
  when: galaxy_munge_key_password != ''
  register: key_content
  changed_when: false

- name: Create munge.key file with password
  copy: content="{{ key_content.stdout }}\n" dest=/mnt/galaxy_storage/munge.key mode=0444
  when: galaxy_munge_key_password != ''

- name: Copy munge.key in the export dir
  template: src=slurm.conf.j2 dest=/mnt/galaxy_storage/slurm.conf

# Configure job_conf.xml
- name: Configure job_conf.xml
  copy:
    content: |
        <?xml version="1.0"?>
        <job_conf>
          <plugins>
            <plugin id="slurm" type="runner" load="galaxy.jobs.runners.drmaa:DRMAAJobRunner" workers="10"/>
          </plugins>
          <handlers>
            <handler id="main" />
          </handlers>
          <destinations default="slurm">
            <destination id="slurm" runner="slurm" tags="mycluster" />
            <param id="embed_metadata_in_job">False</param>
          </destinations>
        </job_conf>
    dest: "/mnt/galaxy_storage/slurm_job_conf.xml"


