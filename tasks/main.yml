---
- name: install docker-py
  pip: name=docker-py

- name: Create /etc/nginx dir
  file: path=/etc/nginx state=directory

- name: Copy nginx.conf file
  copy: src=nginx.conf dest=/etc/nginx/nginx.conf

- name: Copy uwsgi.conf file
  copy: src=uwsgi.conf dest=/etc/nginx/uwsgi.conf

- name: Create /mnt/galaxy_storage dir
  file: path=/mnt/galaxy_storage state=directory

- name: force all notified handlers (to assure docker is restarted)
  meta: flush_handlers

- include: slurm.yml
  when: galaxy_lrms == "slurm"

- name: Start galaxy container
  docker_container:
    name: galaxy
    image: micafer/galaxy
    ports:
     - "8080:80"
     - "8022:22"
     - "8021:21"
     - "9002:9002"
     - "8800:8800"
    env: "{{galaxy_docker_env_vars}}"
    volumes:
     - "/var/run/docker.sock:/var/run/docker.sock"
     - "/mnt/galaxy_storage:/export/"
     - "/etc/nginx/nginx.conf:/etc/nginx/nginx.conf"
     - "/etc/nginx/uwsgi.conf:/etc/nginx/conf.d/uwsgi.conf"
    privileged: yes 




